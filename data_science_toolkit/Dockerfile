FROM sinclair1992/jupyterhub_gpu
RUN apt-get install apt-utils apt-transport-https ca-certificates dirmngr -y --no-install-recommends && apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv E0C56BD4 && echo "deb https://repo.clickhouse.com/deb/stable/ main/" | tee /etc/apt/sources.list.d/clickhouse.list && apt-get update && DEBIAN_FRONTEND=noninteractive apt-get install -y clickhouse-server clickhouse-client && sed -i 's/<!-- <listen_host>0.0.0.0<\/listen_host> -->/<listen_host>0.0.0.0<\/listen_host>/g' /etc/clickhouse-server/config.xml && sed -i 's/var\/log/home\/data\/clickhouse\/log/g' /etc/clickhouse-server/config.xml
RUN apt-get install -y git build-essential libssl-dev libffi-dev python3-dev python3-pip libsasl2-dev libldap2-dev && pip install apache-superset && pip install Flask-WTF==0.14.3 && superset db upgrade && export FLASK_APP=superset && superset fab create-admin --username admin --firstname admin --lastname user --email admin@fab.org --password admin && superset load_examples && superset init && pip install git+https://github.com/xzkostyan/clickhouse-sqlalchemy

CMD mkdir -p /home/data/clickhouse/log/clickhouse-server && mkdir -p /home/data/clickhouse/tmp && mkdir -p /home/data/clickhouse/user_files && mkdir -p /home/data/clickhouse/access && mkdir -p /home/data/clickhouse/format_schemas && chown -R clickhouse:clickhouse /home/data/clickhouse #&& clickhouse start && superset run -p 8088 --host=0.0.0.0 --with-threads --reload & jupyterhub -f jupyterhub_config.py & tail -f /dev/null
